<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å®æ—¶å¤šå¸ç§æ±‡ç‡è½¬æ¢å™¨</title>

  <!-- âœ… ç½‘ç«™å›¾æ ‡ï¼ˆFaviconï¼‰ -->
  <link rel="icon" href="https://favicon.im/html.captainzeqi.com" type="image/png">
  <link rel="shortcut icon" href="https://favicon.im/html.captainzeqi.com" type="image/png">
  <link rel="apple-touch-icon" href="https://favicon.im/html.captainzeqi.com">

  <!-- ä¸»é¢˜ï¼šå°½é‡æå‰åº”ç”¨ï¼Œé¿å…é—ªçƒ -->
  <script>
    const THEME_KEY = 'preferredTheme'; // 'system' | 'dark' | 'light'
    function getSystemTheme(){
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    function applyTheme(theme){
      const effective = theme === 'system' ? getSystemTheme() : theme;
      document.documentElement.setAttribute('data-theme', effective);
    }
    (function loadThemeImmediately(){
      const saved = localStorage.getItem(THEME_KEY) || 'system';
      applyTheme(saved);
    })();
  </script>

  <!-- ä¾èµ–åº“ï¼ˆå‰ç«¯ç›´ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg-gradient-1: #e6f4ff;
      --bg-gradient-2: #ffffff;
      --header-grad-1: #6eb1da;
      --header-grad-2: #3382cc;
      --text-color: #24374a;
      --muted: #5a6f82;
      --card-bg: #ffffff;
      --card-border: #d6e8f7;
      --input-bg: #f2f8fd;
      --accent: #3a8edb;
      --status-loading-bg: #e9f4ff;
      --status-loading-color: #1e6bb8;
      --status-success-bg: #ebf9f0;
      --status-success-color: #2e7d32;
      --status-error-bg: #fdecea;
      --status-error-color: #c62828;
      --spinner-border: #3a8edb;
      --shadow: rgba(0,0,0,0.08);
      --handle-color: #a0a0a0;
      --stat-positive: #2e7d32;
      --stat-negative: #c62828;
      --stat-neutral: #5a6f82;
    }

    [data-theme="dark"]{
      --bg-gradient-1: #000000;
      --bg-gradient-2: #1a1a1a;
      --header-grad-1: rgb(46, 36, 5);
      --header-grad-2: #1a1600ff;
      --text-color: #f0d479;
      --muted: #bda65d;
      --card-bg: #111111;
      --card-border: rgba(255,215,0,0.15);
      --input-bg: #1b1b1b;
      --accent: #ffd700;
      --status-loading-bg: rgba(255,215,0,0.08);
      --status-loading-color: #ffd700;
      --status-success-bg: rgba(46,125,50,0.15);
      --status-success-color: #7bd38a;
      --status-error-bg: rgba(198,40,40,0.15);
      --status-error-color: #ff8a80;
      --spinner-border: #ffd700;
      --shadow: rgba(0,0,0,0.7);
      --handle-color: #bda65d;
      --stat-positive: #7bd38a;
      --stat-negative: #ff8a80;
      --stat-neutral: #bda65d;
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
      min-height:100vh; padding:20px; color: var(--text-color);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      transition: background 300ms ease, color 300ms ease;
    }

    .container{
      max-width:900px; margin:0 auto; background: var(--card-bg);
      border-radius:18px; box-shadow:0 10px 25px var(--shadow);
      overflow:hidden; border:1px solid var(--card-border);
      transition: background 300ms ease, border-color 300ms ease;
    }

    .header{
      background: linear-gradient(135deg, var(--header-grad-1) 0%, var(--header-grad-2) 100%);
      color:white; text-align:center; padding:30px; position:relative;
    }
    .header h1{ font-size:2.3em; margin-bottom:8px; }
    .header p{ font-size:1.1em; opacity:0.95; }

    .theme-toggle{
      position:absolute; right:18px; top:18px;
      background: rgba(255,255,255,0.12); border:none; color:white;
      padding:8px 12px; border-radius:12px; cursor:pointer;
      display:flex; align-items:center; gap:8px; font-weight:600;
      backdrop-filter: blur(6px);
      transition: transform .18s ease, background .18s ease;
    }
    .theme-toggle:hover{ transform: translateY(-3px); }
    [data-theme="dark"] .theme-toggle{ background: rgba(255,255,255,0.06); }

    .content{ padding:30px; }

    .status{
      text-align:center; margin-bottom:20px; padding:14px;
      border-radius:10px; font-weight:500;
    }
    .status.loading{ background: var(--status-loading-bg); color: var(--status-loading-color); }
    .status.success{ background: var(--status-success-bg); color: var(--status-success-color); }
    .status.error{ background: var(--status-error-bg); color: var(--status-error-color); }

    .currency-list{ display:flex; flex-direction:column; gap:15px; }

    .currency-item{
      display:flex; align-items:center; justify-content:space-between;
      background: var(--card-bg); border-radius:12px; padding:15px 20px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.03);
      border:1px solid var(--card-border); transition: all 0.25s ease;
      cursor: default;
    }

    .drag-handle{
      cursor: grab; font-size:1.2em; color: var(--handle-color);
      margin-right:15px; flex-shrink:0;
    }
    .drag-handle:active{ cursor: grabbing; }

    .currency-item.sortable-ghost{
      opacity:0.2; background-color: var(--accent);
      border:1px dashed var(--accent);
    }

    .currency-item:hover{
      border-color: var(--accent);
      background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));
    }

    .currency-left{ display:flex; align-items:center; gap:12px; }
    .flag{ width:36px; height:24px; border-radius:4px; object-fit:cover; }

    .currency-info{ display:flex; flex-direction:column; }
    .currency-code{ font-size:1.1em; font-weight:700; }
    .currency-name{ font-size:0.85em; color: var(--muted); }

    .currency-middle{
      flex:1; text-align:center; font-size:0.9em;
      color: var(--text-color); cursor:pointer;
    }
    .currency-middle:hover{ color: var(--accent); }

    .currency-right{ flex-shrink:0; width:180px; }
    .currency-input{
      width:100%; padding:10px 14px; font-size:1.05em;
      border:1px solid var(--card-border); border-radius:8px;
      background: var(--input-bg); text-align:right; font-weight:600;
      transition:0.2s; color: var(--text-color);
    }
    .currency-input::placeholder{ color: var(--muted); }
    .currency-input:focus{
      outline:none; border-color: var(--accent); background: var(--card-bg);
      box-shadow: 0 0 0 3px rgba(109,213,237,0.08);
    }

    .last-updated{
      text-align:center; color: var(--muted); font-size:0.9em;
      margin-top:20px; padding:12px; background: rgba(255,255,255,0.02);
      border-radius:8px;
    }

    .refresh-btn{
      display:block; margin:15px auto 0; padding:10px 24px;
      background: linear-gradient(135deg, var(--header-grad-1) 0%, var(--header-grad-2) 100%);
      color:white; border:none; border-radius:25px;
      font-size:1em; font-weight:600; cursor:pointer;
      box-shadow: 0 4px 12px rgba(33,147,176,0.25);
      transition: transform 0.2s ease;
    }
    .refresh-btn:hover{ transform: translateY(-2px); }
    .refresh-btn:disabled{ opacity:0.6; cursor:not-allowed; }

    .spinner{
      display:inline-block; width:16px; height:16px;
      border:2px solid var(--spinner-border); border-radius:50%;
      border-top-color: transparent; animation: spin 1s linear infinite;
      margin-right:6px;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .history-modal{
      position:fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.45);
      display:flex; justify-content:center; align-items:center;
      z-index:1000; opacity:0; visibility:hidden; transition:0.3s;
    }
    .history-modal.active{
      opacity:1; visibility: visible; backdrop-filter: blur(6px);
    }

    .modal-content{
      background:var(--card-bg); padding:25px; border-radius:15px;
      width:90%; max-width:750px; transform:scale(0.9); transition:0.3s;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      border: 1px solid var(--card-border);
      color: var(--text-color);
    }
    .history-modal.active .modal-content{ transform:scale(1); }

    .modal-header{
      display:flex; justify-content:space-between;
      align-items:center; margin-bottom:15px;
    }
    .modal-close{
      border:none; background:none; font-size:1.5em;
      cursor:pointer; color:var(--muted); transition: 0.2s;
    }
    .modal-close:hover{ color:var(--accent); }

    .time-range-buttons{
      display:flex; gap:10px; margin-bottom:20px; justify-content:center;
      flex-wrap:wrap;
    }
    .time-range-buttons button{
      padding:8px 15px; border-radius:15px; border: 1px solid var(--card-border);
      background: var(--input-bg); color: var(--text-color);
      cursor:pointer; font-weight:500; transition: background 0.2s, border-color 0.2s;
    }
    .time-range-buttons button:hover{ border-color: var(--accent); }
    .time-range-buttons button.active{
      background: var(--accent); color:white; border-color: var(--accent);
    }

    .history-stats{
      display:flex; justify-content:space-around; text-align:center;
      margin-top:15px; padding:10px 0; border-top:1px solid var(--card-border);
      font-size:0.9em; flex-wrap:wrap;
    }
    .stat-item{ flex:1; padding:0 5px; min-width:140px; margin-bottom:10px; }
    .stat-value{ font-size:1.1em; font-weight:700; margin-top:3px; }
    .stat-high{ color: var(--stat-positive); }
    .stat-low{ color: var(--stat-negative); }
    .stat-change-up{ color: var(--stat-positive); }
    .stat-change-down{ color: var(--stat-negative); }
    .stat-change-neutral{ color: var(--stat-neutral); }

    .attribution{
      text-align:center;
      margin-top:10px;
      font-size:0.85em;
      color: var(--muted);
    }
    .attribution a{ color: var(--muted); }
    .attribution a:hover{ color: var(--accent); }

    @media(max-width:768px){
      .currency-item{flex-direction:column;align-items:flex-start;}
      .currency-middle{text-align:left;margin:8px 0;}
      .currency-right{width:100%;}
      .theme-toggle{ right: 12px; top: 12px; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ’± å®æ—¶æ±‡ç‡è½¬æ¢å™¨</h1>
      <p>æ”¯æŒå¤šå¸ç§å®æ—¶è½¬æ¢ï¼ˆå…è´¹ API + è‡ªåŠ¨å…œåº•ï¼‰</p>

      <button id="themeToggle" class="theme-toggle" aria-label="åˆ‡æ¢ä¸»é¢˜" title="å•å‡»åˆ‡æ¢ä¸»é¢˜ï¼ˆè·Ÿéšç³»ç»Ÿ â†’ æ·±è‰² â†’ æµ…è‰²ï¼‰">
        ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ
      </button>

      <button id="refreshBtn" class="refresh-btn">ğŸ”„ åˆ·æ–°æ±‡ç‡</button>
    </div>

    <div class="content">
      <div id="status" class="status loading"><div class="spinner"></div> æ­£åœ¨è·å–æœ€æ–°æ±‡ç‡æ•°æ®...</div>
      <div id="currencyList" class="currency-list"></div>

      <div id="lastUpdated" class="last-updated">æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´: è·å–ä¸­...</div>

      <!-- open.er-api.com çš„ open access è¦æ±‚ Attributionï¼ˆå»ºè®®ä¿ç•™ï¼‰ -->
      <div class="attribution">
        Rates by <a href="https://www.exchangerate-api.com" target="_blank" rel="noopener">ExchangeRate-API</a>
      </div>
    </div>
  </div>

  <!-- å†å²å¼¹çª— -->
  <div id="historyModal" class="history-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle"></h2>
        <button class="modal-close" id="modalClose" aria-label="å…³é—­">&times;</button>
      </div>

      <div class="time-range-buttons" id="timeRangeButtons">
        <button data-days="5">5å¤©</button>
        <button data-days="30" class="active">30å¤©</button>
        <button data-days="365">1å¹´</button>
        <button data-days="1825">5å¹´</button>
      </div>

      <div style="height:350px;"><canvas id="historyChart"></canvas></div>
      <div id="historyStats" class="history-stats"></div>
    </div>
  </div>

<script>
/* ------------------- ä¸»é¢˜æ§åˆ¶ï¼ˆUI æ›´æ–°ï¼‰ ------------------- */
function updateThemeToggleUI(savedTheme, effective){
  const btn = document.getElementById('themeToggle');
  let label = '';
  if(savedTheme === 'system') label = 'ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ';
  else if(savedTheme === 'dark') label = 'ğŸŒ™ æ·±è‰²';
  else label = 'ğŸŒ æµ…è‰²';
  btn.innerText = label;
  btn.title = `å½“å‰: ${label}ï¼ˆæ˜¾ç¤º: ${effective === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}ï¼‰ã€‚å•å‡»åˆ‡æ¢ä¸»é¢˜ï¼ˆè·Ÿéšç³»ç»Ÿ â†’ æ·±è‰² â†’ æµ…è‰²ï¼‰`;
}
function loadThemeUI(){
  const saved = localStorage.getItem(THEME_KEY) || 'system';
  const effective = saved === 'system' ? getSystemTheme() : saved;
  updateThemeToggleUI(saved, effective);
}
function cycleTheme(){
  const cur = localStorage.getItem(THEME_KEY) || 'system';
  const next = cur === 'system' ? 'dark' : (cur === 'dark' ? 'light' : 'system');
  localStorage.setItem(THEME_KEY, next);
  applyTheme(next);
  const effective = next === 'system' ? getSystemTheme() : next;
  updateThemeToggleUI(next, effective);
}
const mediaQuery = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
if(mediaQuery){
  try{
    mediaQuery.addEventListener('change', () => {
      const saved = localStorage.getItem(THEME_KEY) || 'system';
      if(saved === 'system'){ applyTheme('system'); loadThemeUI(); }
    });
  }catch(e){
    mediaQuery.addListener(() => {
      const saved = localStorage.getItem(THEME_KEY) || 'system';
      if(saved === 'system'){ applyTheme('system'); loadThemeUI(); }
    });
  }
}

/* ------------------- é…ç½®ä¸çŠ¶æ€ ------------------- */
const CURRENCY_ORDER_KEY = 'currencyOrder';

// ä½ åŸæ¥çš„å¸ç§è¡¨
const allCurrenciesMap = {
  USD:{name:'ç¾å…ƒ',country:'us'}, EUR:{name:'æ¬§å…ƒ',country:'eu'}, CNY:{name:'äººæ°‘å¸',country:'cn'},
  JPY:{name:'æ—¥å…ƒ',country:'jp'}, GBP:{name:'è‹±é•‘',country:'gb'}, AUD:{name:'æ¾³å…ƒ',country:'au'},
  CAD:{name:'åŠ å…ƒ',country:'ca'}, CHF:{name:'ç‘å£«æ³•éƒ',country:'ch'}, HKD:{name:'æ¸¯å¸',country:'hk'},
  SGD:{name:'æ–°åŠ å¡å…ƒ',country:'sg'}, KRW:{name:'éŸ©å…ƒ',country:'kr'}, INR:{name:'å°åº¦å¢æ¯”',country:'in'},
  THB:{name:'æ³°é“¢',country:'th'}, VND:{name:'è¶Šå—ç›¾',country:'vn'}, RUB:{name:'ä¿„ç½—æ–¯å¢å¸ƒ',country:'ru'},
  ZAR:{name:'å—éå…°ç‰¹',country:'za'}, TWD:{name:'æ–°å°å¸',country:'tw'}, IDR:{name:'å°å°¼ç›¾',country:'id'},
  MYR:{name:'é©¬æ¥è¥¿äºšæ—å‰ç‰¹',country:'my'}, PHP:{name:'è²å¾‹å®¾æ¯”ç´¢',country:'ph'},
  TRY:{name:'åœŸè€³å…¶é‡Œæ‹‰',country:'tr'}
};

let currentCurrencyCodes = Object.keys(allCurrenciesMap);
let exchangeRates = {}; // å§‹ç»ˆç»Ÿä¸€æˆ USD ä¸ºåŸºå‡†ï¼šrate[XXX] = 1 USD -> XXX
let baseCurrency = 'USD';
let isUpdating = false;

let myChart = null;
let currentTarget = null;

/* ------------------- æ•°æ®æºï¼ˆå…è´¹ + å…¼å®¹ CORS + è‡ªåŠ¨å…œåº•ï¼‰ ------------------- */
const rateSources = [
  {
    name: 'ExchangeRate-API (Open Access)',
    url: 'https://open.er-api.com/v6/latest/USD',
    parseToUsdBase: (d) => {
      if(!d || d.result !== 'success' || !d.rates) throw new Error('Bad response');
      return { usdRates: d.rates, meta: { lastUtc: d.time_last_update_utc, nextUtc: d.time_next_update_utc } };
    }
  },
  {
    name: 'Frankfurter',
    url: 'https://api.frankfurter.dev/latest',
    parseToUsdBase: (d) => {
      if(!d || !d.rates || !d.rates.USD) throw new Error('Bad response / missing USD');
      const eurToUsd = d.rates.USD;
      const usdRates = {};
      for(const code in d.rates){
        usdRates[code] = d.rates[code] / eurToUsd;
      }
      usdRates.USD = 1;
      return { usdRates, meta: { lastUtc: d.date ? `${d.date} (ECB ref)` : '' } };
    }
  }
];

/* å†å²æ•°æ®ç”¨ Frankfurterï¼ˆæ—¶é—´åºåˆ—æœ€ç¨³ï¼‰ */
const historyApi = {
  url: 'https://api.frankfurter.dev',
  fetchHistory: async (base, target, days) => {
    const today = new Date();
    const end = new Date(); end.setDate(today.getDate() - 1);
    const start = new Date(); start.setDate(today.getDate() - days);
    const s = start.toISOString().split('T')[0];
    const e = end.toISOString().split('T')[0];

    const rt = await fetch(`${historyApi.url}/${s}..${e}?from=EUR&to=${target}`);
    if(!rt.ok) throw new Error('Target history fetch failed');
    const dt = await rt.json();
    const targetRates = dt.rates || {};

    let finalRates = [];

    if(base === 'EUR'){
      finalRates = Object.keys(targetRates).map(dateKey => ({
        date: dateKey,
        rate: targetRates[dateKey][target]
      }))
      .filter(d => d.rate)
      .sort((a,b)=>new Date(a.date)-new Date(b.date));
    }else{
      const rb = await fetch(`${historyApi.url}/${s}..${e}?from=EUR&to=${base}`);
      if(!rb.ok) throw new Error('Base history fetch failed');
      const db = await rb.json();
      const baseRates = db.rates || {};

      finalRates = Object.keys(targetRates).map(dateKey => {
        const t = targetRates[dateKey] ? targetRates[dateKey][target] : null;
        const b = baseRates[dateKey] ? baseRates[dateKey][base] : null;
        if(t && b) return { date: dateKey, rate: t / b };
        return null;
      })
      .filter(Boolean)
      .sort((a,b)=>new Date(a.date)-new Date(b.date));
    }

    const currentRate = exchangeRates[target] / exchangeRates[base];
    if(currentRate && finalRates.length > 0){
      finalRates.push({ date: today.toISOString().split('T')[0], rate: currentRate });
    }
    return finalRates;
  }
};

/* ------------------- ç¼“å­˜ç­–ç•¥ ------------------- */
const RATES_CACHE_KEY = 'ratesCacheV1';
const CACHE_TTL_MS = 60 * 60 * 1000;

function loadRatesCache(){
  try{
    const raw = localStorage.getItem(RATES_CACHE_KEY);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.usdRates || !obj.savedAt) return null;
    if(Date.now() - obj.savedAt > CACHE_TTL_MS) return null;
    return obj;
  }catch(_){ return null; }
}
function saveRatesCache(payload){
  try{ localStorage.setItem(RATES_CACHE_KEY, JSON.stringify(payload)); }catch(_){}
}

/* ------------------- æ’åºå­˜å– ------------------- */
function loadOrder(){
  const savedOrder = localStorage.getItem(CURRENCY_ORDER_KEY);
  if(!savedOrder){ currentCurrencyCodes = Object.keys(allCurrenciesMap); return; }

  try{
    const savedCodes = JSON.parse(savedOrder);
    const newOrder = savedCodes.filter(code => allCurrenciesMap[code]);
    const missing = Object.keys(allCurrenciesMap).filter(code => !newOrder.includes(code));
    currentCurrencyCodes = [...newOrder, ...missing];
  }catch(e){
    currentCurrencyCodes = Object.keys(allCurrenciesMap);
  }
}
function saveOrder(){
  localStorage.setItem(CURRENCY_ORDER_KEY, JSON.stringify(currentCurrencyCodes));
}
function initSortable(){
  const list = document.getElementById('currencyList');
  Sortable.create(list, {
    animation:150,
    handle:'.drag-handle',
    ghostClass:'sortable-ghost',
    onEnd:(evt)=>{
      const item = currentCurrencyCodes[evt.oldIndex];
      currentCurrencyCodes.splice(evt.oldIndex, 1);
      currentCurrencyCodes.splice(evt.newIndex, 0, item);
      saveOrder();
      updateRateDisplays();

      const active = currentCurrencyCodes.find(k=>{
        const v = (document.getElementById(`input-${k}`)?.value || '').replace(/,/g,'');
        return parseFloat(v) > 0;
      });
      if(active) onInputChange(active);
    }
  });
}

/* ------------------- UI æ¸²æŸ“ ------------------- */
function updateStatus(type, html){
  const el = document.getElementById('status');
  el.className = `status ${type}`;
  el.innerHTML = html;
}
function formatNumber(num){
  if(isNaN(num)) return '';
  return num.toLocaleString('en-US', { minimumFractionDigits:2, maximumFractionDigits:2 });
}
function createCurrencyItems(){
  const list = document.getElementById('currencyList');
  list.innerHTML = '';

  currentCurrencyCodes.forEach(code=>{
    const info = allCurrenciesMap[code];
    if(!info) return;

    const item = document.createElement('div');
    item.className = 'currency-item';
    item.dataset.code = code;

    item.innerHTML = `
      <span class="drag-handle" title="æ‹–æ‹½ä»¥é‡æ–°æ’åº">â‹®â‹®</span>
      <div class="currency-left">
        <img src="https://flagcdn.com/w40/${info.country}.png" class="flag" alt="${code}">
        <div class="currency-info">
          <div class="currency-code">${code}</div>
          <div class="currency-name">${info.name}</div>
        </div>
      </div>
      <div class="currency-middle" id="rate-${code}">æ±‡ç‡: åŠ è½½ä¸­...</div>
      <div class="currency-right">
        <input type="text" id="input-${code}" class="currency-input" placeholder="0.00">
      </div>
    `;
    list.appendChild(item);

    item.querySelector(`#rate-${code}`).addEventListener('click', ()=>showHistoryChart(code, 30));
    const input = item.querySelector(`#input-${code}`);
    input.addEventListener('input', ()=>onInputChange(code));
    input.addEventListener('focus', ()=>onInputFocus(code));
  });

  initSortable();
}

function updateRateDisplays(){
  currentCurrencyCodes.forEach(code=>{
    const el = document.getElementById(`rate-${code}`);
    if(!el) return;

    if(code === baseCurrency){
      el.textContent = 'æ±‡ç‡: 1.0000 (åŸºå‡†) (ç‚¹å‡»æŸ¥çœ‹)';
      return;
    }
    if(!exchangeRates[baseCurrency] || !exchangeRates[code]){
      el.textContent = 'æ±‡ç‡: æ•°æ®ä¸å¯ç”¨';
      return;
    }
    const r = exchangeRates[code] / exchangeRates[baseCurrency];
    el.textContent = r ? `æ±‡ç‡: ${r.toFixed(4)} (ç‚¹å‡»æŸ¥çœ‹)` : 'æ±‡ç‡: æ•°æ®ä¸å¯ç”¨';
  });
}

function onInputFocus(code){
  baseCurrency = code;
  updateRateDisplays();
  const input = document.getElementById(`input-${code}`);
  if(input) input.value = input.value.replace(/,/g,'');
}

function onInputChange(code){
  if(isUpdating || !exchangeRates[code]) return;
  const input = document.getElementById(`input-${code}`);
  const val = parseFloat((input?.value || '').replace(/,/g,'')) || 0;

  baseCurrency = code;
  updateRateDisplays();

  isUpdating = true;
  currentCurrencyCodes.forEach(k=>{
    const targetInput = document.getElementById(`input-${k}`);
    if(!targetInput) return;
    if(k === code) return;

    if(!exchangeRates[k] || !exchangeRates[code]){
      targetInput.value = '';
      return;
    }
    const converted = val * exchangeRates[k] / exchangeRates[code];
    targetInput.value = formatNumber(converted);
  });
  isUpdating = false;
}

/* ------------------- æ‹‰å–å®æ—¶æ±‡ç‡ï¼ˆå¼ºå…œåº• + ç¼“å­˜ï¼‰ ------------------- */
async function fetchExchangeRates({ force = false } = {}){
  updateStatus('loading', '<div class="spinner"></div> æ­£åœ¨è·å–æœ€æ–°æ±‡ç‡æ•°æ®...');
  const refreshBtn = document.getElementById('refreshBtn');
  refreshBtn.disabled = true;

  if(!force){
    const cache = loadRatesCache();
    if(cache){
      exchangeRates = cache.usdRates;
      updateStatus('success', `å·²ä½¿ç”¨ç¼“å­˜æ±‡ç‡ (æ¥æº: ${cache.sourceName})`);
      updateRateDisplays();
      document.getElementById('lastUpdated').textContent =
        `æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´: ${cache.displayTime || 'ç¼“å­˜'} (æ¥æº: ${cache.sourceName})`;
      refreshBtn.disabled = false;
      refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°æ±‡ç‡';
      return;
    }
  }

  for(const source of rateSources){
    try{
      const r = await fetch(source.url, { cache: 'no-store' });
      if(!r.ok) throw new Error(`Fetch failed: ${source.name}`);
      const d = await r.json();
      const { usdRates, meta } = source.parseToUsdBase(d);

      usdRates.USD = 1;
      exchangeRates = usdRates;

      const displayTime = meta?.lastUtc || new Date().toLocaleString('zh-CN');

      updateStatus('success', `æ±‡ç‡æ•°æ®è·å–æˆåŠŸ (æ¥æº: ${source.name})`);
      updateRateDisplays();
      document.getElementById('lastUpdated').textContent =
        `æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´: ${displayTime} (æ¥æº: ${source.name})`;

      saveRatesCache({
        usdRates: exchangeRates,
        sourceName: source.name,
        displayTime,
        savedAt: Date.now()
      });

      refreshBtn.disabled = false;
      refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°æ±‡ç‡';
      return;
    }catch(e){
      console.error('source fail:', source.name, e);
    }
  }

  useSimulatedRates();
  refreshBtn.disabled = false;
  refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°æ±‡ç‡';
}

function useSimulatedRates(){
  exchangeRates = {
    USD:1, EUR:0.85, CNY:7.25, JPY:148.5, GBP:0.78, AUD:1.52,
    CAD:1.36, CHF:0.91, HKD:7.8, SGD:1.35, KRW:1320, INR:83.2,
    THB:34.1, VND:23600, RUB:90.5, ZAR:19.7, TWD:30.5,
    IDR:15500, MYR:4.7, PHP:56.2, TRY:27.0
  };
  updateStatus('error','æ±‡ç‡æ•°æ®è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®');
  updateRateDisplays();
  document.getElementById('lastUpdated').textContent =
    `æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´: ${new Date().toLocaleString('zh-CN')} (æ¨¡æ‹Ÿ)`;
}

async function refreshRates(){
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div>åˆ·æ–°ä¸­...';
  await fetchExchangeRates({ force: true });

  const active = currentCurrencyCodes.find(k=>{
    const v = (document.getElementById(`input-${k}`)?.value || '').replace(/,/g,'');
    return parseFloat(v) > 0;
  });
  if(active) onInputChange(active);
  else{
    const baseVal = document.getElementById(`input-${baseCurrency}`)?.value || '';
    if(baseVal.length > 0) onInputChange(baseCurrency);
  }

  btn.disabled = false;
  btn.innerHTML = 'ğŸ”„ åˆ·æ–°æ±‡ç‡';
}

/* ------------------- å†å²å¼¹çª—ä¸å›¾è¡¨ ------------------- */
function closeHistoryModal(){
  document.getElementById('historyModal').classList.remove('active');
  if(myChart){ myChart.destroy(); myChart = null; }
  currentTarget = null;
}
function setActiveDaysButton(days){
  document.querySelectorAll('#timeRangeButtons button').forEach(btn=>{
    btn.classList.toggle('active', parseInt(btn.dataset.days,10) === days);
  });
}
function showHistoryChart(targetCode, days=30){
  currentTarget = targetCode;
  const modal = document.getElementById('historyModal');
  modal.classList.add('active');
  modal.onclick = (e)=>{ if(e.target === modal) closeHistoryModal(); };

  if(targetCode === baseCurrency){
    document.getElementById('modalTitle').textContent = `${baseCurrency} (åŸºå‡†)`;
    const canvas = document.getElementById('historyChart');
    const ctx = canvas.getContext('2d');
    if(myChart) myChart.destroy();
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || '#24374a';
    ctx.fillText('åŸºå‡†è´§å¸æ’å®šä¸º1ï¼Œæ— å†å²æ³¢åŠ¨', canvas.width/2, canvas.height/2);
    document.getElementById('historyStats').innerHTML = '';
    setActiveDaysButton(days);
    return;
  }

  loadHistory(targetCode, days);
}

async function loadHistory(targetCode, days){
  const modalTitle = document.getElementById('modalTitle');
  const chartCanvas = document.getElementById('historyChart');
  const ctx = chartCanvas.getContext('2d');
  const statsDiv = document.getElementById('historyStats');

  setActiveDaysButton(days);
  if(myChart) myChart.destroy();
  ctx.clearRect(0,0,chartCanvas.width,chartCanvas.height);

  modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡ (æ­£åœ¨åŠ è½½...)`;
  statsDiv.innerHTML = `<div class="status loading" style="width:100%"><div class="spinner"></div> æ­£åœ¨è·å–å†å²æ•°æ®...</div>`;

  try{
    const data = await historyApi.fetchHistory(baseCurrency, targetCode, days);

    if(!data || data.length === 0){
      modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡ (è¿‘${days}å¤©)`;
      statsDiv.innerHTML = '';
      ctx.font='16px sans-serif'; ctx.textAlign='center';
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--status-error-color').trim() || '#c62828';
      ctx.fillText('å†å²æ•°æ®è·å–å¤±è´¥æˆ–æ— æ•°æ®', chartCanvas.width/2, chartCanvas.height/2);
      return;
    }

    const labels = data.map(d=>new Date(d.date).toLocaleDateString('zh-CN',{
      month:'numeric', day:'numeric', year: days>=365 ? '2-digit' : undefined
    }));
    const rates = data.map(d=>d.rate);

    const minRate = Math.min(...rates);
    const maxRate = Math.max(...rates);
    const firstRate = rates[0];
    const lastRate = rates[rates.length-1];
    const change = lastRate - firstRate;
    const changePercent = (change / firstRate) * 100;

    const minIndex = rates.indexOf(minRate);
    const maxIndex = rates.indexOf(maxRate);

    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#3a8edb';
    const chartText = getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim() || '#24374a';
    const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--card-border').trim();

    const minColor = getComputedStyle(document.documentElement).getPropertyValue('--stat-negative').trim() || '#c62828';
    const maxColor = getComputedStyle(document.documentElement).getPropertyValue('--stat-positive').trim() || '#2e7d32';

    const pointBackgroundColors = rates.map((_,idx)=>{
      if(idx===minIndex) return minColor;
      if(idx===maxIndex) return maxColor;
      return accent;
    });
    const pointRadii = rates.map((_,idx)=>(idx===minIndex||idx===maxIndex)?6:3);

    myChart = new Chart(ctx,{
      type:'line',
      data:{
        labels,
        datasets:[{
          label:`${baseCurrency}â†’${targetCode}`,
          data:rates,
          borderColor: accent,
          backgroundColor: accent + '30',
          fill:true,
          tension:0.2,
          pointRadius: pointRadii,
          pointBackgroundColor: pointBackgroundColors
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        scales:{
          x:{ ticks:{ color: chartText, maxTicksLimit:10 }, grid:{ color:gridColor } },
          y:{
            beginAtZero:false,
            ticks:{ color: chartText, callback:(v)=>Number(v).toFixed(4) },
            grid:{ color:gridColor }
          }
        },
        plugins:{
          legend:{ display:false },
          tooltip:{ callbacks:{ label:(c)=>` æ±‡ç‡: ${c.parsed.y.toFixed(4)}` } }
        }
      }
    });

    const changeClass = change > 0 ? 'stat-change-up' : (change < 0 ? 'stat-change-down' : 'stat-change-neutral');
    const changeSign = change > 0 ? 'â†‘' : (change < 0 ? 'â†“' : '');

    statsDiv.innerHTML = `
      <div class="stat-item">
        <div>èµ·å§‹æ±‡ç‡ (${labels[0]}):</div>
        <div class="stat-value">${firstRate.toFixed(4)}</div>
      </div>
      <div class="stat-item">
        <div>ç»“æŸæ±‡ç‡ (${labels[labels.length-1]}):</div>
        <div class="stat-value">${lastRate.toFixed(4)}</div>
      </div>
      <div class="stat-item">
        <div>${days}å¤©å˜åŒ–:</div>
        <div class="stat-value ${changeClass}">${changeSign} ${Math.abs(change).toFixed(4)} (${changePercent.toFixed(2)}%)</div>
      </div>
      <div class="stat-item">
        <div>æœ€é«˜æ±‡ç‡ (${labels[maxIndex]}):</div>
        <div class="stat-value stat-high">${maxRate.toFixed(4)}</div>
      </div>
      <div class="stat-item">
        <div>æœ€ä½æ±‡ç‡ (${labels[minIndex]}):</div>
        <div class="stat-value stat-low">${minRate.toFixed(4)}</div>
      </div>
    `;
    modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡ (è¿‘${days}å¤©)`;

  }catch(e){
    console.error(e);
    statsDiv.innerHTML = '';
    modalTitle.textContent = `${baseCurrency} åˆ° ${targetCode} å†å²æ±‡ç‡`;
    ctx.font='16px sans-serif'; ctx.textAlign='center';
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--status-error-color').trim() || '#c62828';
    ctx.fillText('å†å²æ•°æ®è·å–å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', chartCanvas.width/2, chartCanvas.height/2);
  }
}

/* ------------------- å¯åŠ¨å…¥å£ ------------------- */
window.addEventListener('load', ()=>{
  loadThemeUI();
  document.getElementById('themeToggle').addEventListener('click', cycleTheme);

  document.getElementById('modalClose').addEventListener('click', closeHistoryModal);

  document.querySelectorAll('#timeRangeButtons button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const days = parseInt(btn.dataset.days,10);
      if(!currentTarget) return;
      loadHistory(currentTarget, days);
    });
  });

  document.getElementById('refreshBtn').addEventListener('click', refreshRates);

  loadOrder();
  createCurrencyItems();
  fetchExchangeRates({ force:false });
});
</script>
</body>
</html>
