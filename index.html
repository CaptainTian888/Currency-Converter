<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>èˆ¹é•¿-æ±‡ç‡è½¬æ¢å™¨</title>

  <!-- âœ… ç½‘ç«™å›¾æ ‡ï¼ˆFaviconï¼‰ -->
  <link rel="icon" href="https://favicon.im/html.captainzeqi.com" type="image/png">
  <link rel="shortcut icon" href="https://favicon.im/html.captainzeqi.com" type="image/png">
  <link rel="apple-touch-icon" href="https://favicon.im/html.captainzeqi.com">

  <!-- ä¸»é¢˜ï¼šå°½é‡æå‰åº”ç”¨ï¼Œé¿å…é—ªçƒ -->
  <script>
    const THEME_KEY = 'preferredTheme'; // 'system' | 'dark' | 'light'
    function getSystemTheme(){
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }
    function applyTheme(theme){
      const effective = theme === 'system' ? getSystemTheme() : theme;
      document.documentElement.setAttribute('data-theme', effective);
    }
    (function loadThemeImmediately(){
      const saved = localStorage.getItem(THEME_KEY) || 'system';
      applyTheme(saved);
    })();
  </script>

  <style>
    :root{
      --bg-gradient-1: #e6f4ff;
      --bg-gradient-2: #ffffff;
      --header-grad-1: #6eb1da;
      --header-grad-2: #3382cc;

      --text-color: #24374a;
      --muted: #5a6f82;
      --card-bg: #ffffff;
      --card-border: #d6e8f7;
      --input-bg: #f2f8fd;

      --accent: #3a8edb;

      --status-loading-bg: #e9f4ff;
      --status-loading-color: #1e6bb8;
      --status-success-bg: #ebf9f0;
      --status-success-color: #2e7d32;
      --status-error-bg: #fdecea;
      --status-error-color: #c62828;

      --spinner-border: #3a8edb;
      --shadow: rgba(0,0,0,0.08);

      --chip-bg: rgba(255,255,255,0.65);
      --chip-border: rgba(0,0,0,0.06);
    }

    [data-theme="dark"]{
      --bg-gradient-1: #000000;
      --bg-gradient-2: #1a1a1a;
      --header-grad-1: rgb(46, 36, 5);
      --header-grad-2: #1a1600ff;

      --text-color: #f0d479;
      --muted: #bda65d;
      --card-bg: #111111;
      --card-border: rgba(255,215,0,0.15);
      --input-bg: #1b1b1b;

      --accent: #ffd700;

      --status-loading-bg: rgba(255,215,0,0.08);
      --status-loading-color: #ffd700;
      --status-success-bg: rgba(46,125,50,0.15);
      --status-success-color: #7bd38a;
      --status-error-bg: rgba(198,40,40,0.15);
      --status-error-color: #ff8a80;

      --spinner-border: #ffd700;
      --shadow: rgba(0,0,0,0.7);

      --chip-bg: rgba(255,255,255,0.06);
      --chip-border: rgba(255,255,255,0.08);
    }

    *{ margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      background: linear-gradient(135deg, var(--bg-gradient-1) 0%, var(--bg-gradient-2) 100%);
      min-height:100vh;
      padding:20px;
      color: var(--text-color);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background 300ms ease, color 300ms ease;
    }

    .container{
      max-width: 1180px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 10px 25px var(--shadow);
      overflow: hidden;
      border: 1px solid var(--card-border);
      transition: background 300ms ease, border-color 300ms ease;
    }

    .header{
      background: linear-gradient(135deg, var(--header-grad-1) 0%, var(--header-grad-2) 100%);
      color: white;
      padding: 24px 22px 16px;
      position: relative;
    }
    .header-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .title-wrap h1{
      font-size: 1.9em;
      line-height: 1.15;
      margin-bottom: 6px;
      letter-spacing: .2px;
    }
    .title-wrap p{
      font-size: 1em;
      opacity: .95;
    }

    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border: none;
      cursor: pointer;
      border-radius: 14px;
      padding: 10px 14px;
      font-weight: 900;
      font-size: .95em;
      transition: transform .15s ease, opacity .15s ease, background .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space: nowrap;
    }
    .btn:hover{ transform: translateY(-2px); }
    .btn:disabled{ opacity: .6; cursor: not-allowed; transform:none; }

    .btn-glass{
      background: rgba(255,255,255,0.12);
      color: white;
      backdrop-filter: blur(6px);
    }
    [data-theme="dark"] .btn-glass{
      background: rgba(255,255,255,0.06);
    }

    .btn-primary{
      background: rgba(0,0,0,0.12);
      color: white;
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }
    .btn-primary .spinner{ border-color: #fff; border-top-color: transparent; }

    .content{
      padding: 16px 18px 20px;
    }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 12px;
    }

    .status{
      flex: 1 1 520px;
      padding: 12px 12px;
      border-radius: 12px;
      font-weight: 850;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .status.loading{ background: var(--status-loading-bg); color: var(--status-loading-color); }
    .status.success{ background: var(--status-success-bg); color: var(--status-success-color); }
    .status.error{ background: var(--status-error-bg); color: var(--status-error-color); }

    .right-tools{
      display:flex;
      align-items:center;
      gap:10px;
      flex: 1 1 280px;
      justify-content:flex-end;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 9px 12px;
      border-radius: 14px;
      background: var(--chip-bg);
      border: 1px solid var(--chip-border);
      color: var(--text-color);
      font-weight: 900;
      font-size: .9em;
      user-select:none;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
    }

    .card{
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.04);
      padding: 12px 12px 12px;
      transition: transform .18s ease, border-color .18s ease;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 152px;
    }
    .card:hover{
      border-color: var(--accent);
      transform: translateY(-2px);
    }

    .card-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .cur-left{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width: 0;
      flex: 1;
    }

    .flag{
      width: 34px;
      height: 24px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
      border: 1px solid rgba(0,0,0,0.06);
      background: rgba(0,0,0,0.03);
    }
    [data-theme="dark"] .flag{
      border-color: rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.05);
    }

    .flag-fallback{
      width: 34px;
      height: 24px;
      border-radius: 6px;
      border: 1px solid rgba(0,0,0,0.06);
      background: var(--input-bg);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 950;
      font-size: .75em;
      color: var(--muted);
      flex-shrink: 0;
      user-select:none;
    }
    [data-theme="dark"] .flag-fallback{
      border-color: rgba(255,255,255,0.08);
    }

    .cur-meta{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width: 0;
    }
    .cur-code{
      font-weight: 950;
      letter-spacing: .4px;
      font-size: 1.05em;
      line-height: 1.05;
    }
    .cur-zh{
      font-size: .86em;
      color: var(--text-color);
      font-weight: 950;
      line-height: 1.15;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }
    .cur-en{
      font-size: .78em;
      color: var(--muted);
      font-weight: 800;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .badge{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: .78em;
      font-weight: 950;
      border: 1px solid var(--card-border);
      background: var(--input-bg);
      color: var(--text-color);
      white-space: nowrap;
      user-select:none;
    }

    .rate{
      font-size: .9em;
      color: var(--text-color);
      font-weight: 900;
      user-select:none;
      line-height: 1.25;
    }

    .input{
      width: 100%;
      border: 1px solid var(--card-border);
      background: var(--input-bg);
      border-radius: 12px;
      padding: 12px 12px;
      font-size: 1.05em;
      font-weight: 950;
      text-align: right;
      outline:none;
      color: var(--text-color);
      transition: box-shadow .18s ease, border-color .18s ease, background .18s ease;
    }
    .input::placeholder{ color: var(--muted); font-weight: 900; }
    .input:focus{
      border-color: var(--accent);
      background: var(--card-bg);
      box-shadow: 0 0 0 3px rgba(109,213,237,0.10);
    }

    .footer{
      margin-top: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      padding-top: 10px;
      border-top: 1px dashed var(--card-border);
      color: var(--muted);
      font-weight: 800;
      font-size: .9em;
    }

    .spinner{
      display:inline-block;
      width:16px; height:16px;
      border:2px solid var(--spinner-border);
      border-radius:50%;
      border-top-color: transparent;
      animation: spin 1s linear infinite;
    }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    /* å“åº”å¼ */
    @media (max-width: 1160px){
      .grid{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    @media (max-width: 900px){
      .grid{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      body{ padding: 12px; }
      .content{ padding: 14px; }
      .header{ padding: 18px 16px 14px; }
    }
    @media (max-width: 420px){
      .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="header-top">
        <div class="title-wrap">
          <h1>ğŸ’± èˆ¹é•¿-å®æ—¶æ±‡ç‡è½¬æ¢å™¨</h1>
        </div>

        <div class="actions">
          <button id="themeToggle" class="btn btn-glass" aria-label="åˆ‡æ¢ä¸»é¢˜" title="å•å‡»åˆ‡æ¢ä¸»é¢˜ï¼ˆè·Ÿéšç³»ç»Ÿ â†’ æ·±è‰² â†’ æµ…è‰²ï¼‰">
            ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ
          </button>

          <button id="refreshBtn" class="btn btn-primary" title="å¼ºåˆ¶åˆ·æ–°ï¼ˆè·³è¿‡ç¼“å­˜ï¼‰">
            ğŸ”„ åˆ·æ–°æ±‡ç‡
          </button>
        </div>
      </div>
    </div>

    <div class="content">
      <div class="toolbar">
        <div id="status" class="status loading"><span class="spinner"></span> æ­£åœ¨åˆå§‹åŒ–ï¼ˆåŠ è½½å¸ç§/å›½æ——/æ±‡ç‡ï¼‰...</div>

        <div class="right-tools">
          <div id="metaChip" class="chip" title="å½“å‰åŸºå‡†å¸ç§">
            åŸºå‡†ï¼š<span id="baseLabel">USD</span> Â· å¸ç§æ•°ï¼š<span id="countLabel">0</span>
          </div>
        </div>
      </div>

      <div id="grid" class="grid"></div>

      <div class="footer">
        <div id="lastUpdated">æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´ï¼šè·å–ä¸­...</div>
        <div>å®æ—¶ï¼šExchangeRate-API</div>
      </div>
    </div>
  </div>

<script>
/* ===========================
   é…ç½®ï¼ˆä½ çš„ API KEYï¼‰
=========================== */
const EXCHANGE_API_KEY = "a30404f6ef35514a2ab3d000";
const EXCHANGE_API_BASE = "https://v6.exchangerate-api.com/v6";

/* ===========================
   ç¼“å­˜ Keys & TTL
=========================== */
const CACHE = {
  RATES: "ratesCacheV3_noHistory",
  CODES: "codesCacheV2",
  COUNTRY_MAP: "currencyCountryMapV2"
};
const TTL = {
  RATES_MS: 60 * 60 * 1000,           // 1å°æ—¶
  CODES_MS: 7 * 24 * 60 * 60 * 1000,  // 7å¤©
  COUNTRY_MS: 7 * 24 * 60 * 60 * 1000 // 7å¤©
};

/* ===========================
   å¸¸ç”¨å¸ç§ç½®é¡¶ï¼ˆå¯è‡ªè¡Œæ‰©å±•ï¼‰
=========================== */
const PREFERRED_ORDER = [
  "USD","CNY","HKD","EUR","GBP","JPY","CAD",
  "AUD","SGD","KRW","TWD","CHF",
  "PHP","MXN","ARS","CLP","COP","PEN",
  "INR","THB","VND","IDR","MYR",
  "RUB","TRY","BRL","ZAR"
];

/* ===========================
   ä¸­æ–‡åç§°æ˜ å°„ï¼ˆé‡ç‚¹ä¿è¯è·¨å¢ƒç”µå•†å¸¸ç”¨å¸ç§ï¼‰
=========================== */
const ZH_NAME = {
  USD:"ç¾å…ƒ", CNY:"äººæ°‘å¸", HKD:"æ¸¯å¸", EUR:"æ¬§å…ƒ", GBP:"è‹±é•‘", JPY:"æ—¥å…ƒ", CAD:"åŠ å…ƒ",
  AUD:"æ¾³å…ƒ", NZD:"æ–°è¥¿å…°å…ƒ", SGD:"æ–°åŠ å¡å…ƒ", KRW:"éŸ©å…ƒ", TWD:"æ–°å°å¸",
  CHF:"ç‘å£«æ³•éƒ", SEK:"ç‘å…¸å…‹æœ—", NOK:"æŒªå¨å…‹æœ—", DKK:"ä¸¹éº¦å…‹æœ—",
  PLN:"æ³¢å…°å…¹ç½—æ", CZK:"æ·å…‹å…‹æœ—", HUF:"åŒˆç‰™åˆ©ç¦æ—", RON:"ç½—é©¬å°¼äºšåˆ—ä¼Š",
  RUB:"ä¿„ç½—æ–¯å¢å¸ƒ", TRY:"åœŸè€³å…¶é‡Œæ‹‰", ILS:"ä»¥è‰²åˆ—æ–°è°¢å…‹å°”",
  AED:"é˜¿è”é…‹è¿ªæ‹‰å§†", SAR:"æ²™ç‰¹é‡Œäºšå°”", INR:"å°åº¦å¢æ¯”",
  THB:"æ³°é“¢", VND:"è¶Šå—ç›¾", IDR:"å°å°¼ç›¾", MYR:"é©¬æ¥è¥¿äºšæ—å‰ç‰¹", PHP:"è²å¾‹å®¾æ¯”ç´¢",
  MXN:"å¢¨è¥¿å“¥æ¯”ç´¢", ARS:"é˜¿æ ¹å»·æ¯”ç´¢", CLP:"æ™ºåˆ©æ¯”ç´¢", COP:"å“¥ä¼¦æ¯”äºšæ¯”ç´¢", PEN:"ç§˜é²ç´¢å°”",
  BRL:"å·´è¥¿é›·äºšå°”", ZAR:"å—éå…°ç‰¹"
};

/* ===========================
   å›½æ——å¼ºåˆ¶è¦†ç›–ï¼ˆè§£å†³â€œæœ‰å¸ç§ä¸æ˜¾ç¤ºå›½æ——â€ï¼‰
=========================== */
const FLAG_OVERRIDE = {
  USD:"US", CNY:"CN", HKD:"HK", EUR:"EU", GBP:"GB", JPY:"JP", CAD:"CA",
  AUD:"AU", NZD:"NZ", SGD:"SG", KRW:"KR", TWD:"TW", CHF:"CH",
  PHP:"PH", MXN:"MX", ARS:"AR", CLP:"CL", COP:"CO", PEN:"PE",
  INR:"IN", THB:"TH", VND:"VN", IDR:"ID", MYR:"MY",
  RUB:"RU", TRY:"TR", BRL:"BR", ZAR:"ZA",
  AED:"AE", SAR:"SA", ILS:"IL"
};

/* ===========================
   å…¨å±€çŠ¶æ€
=========================== */
let supported = [];                // [{code, name}]
let codeNameEN = {};               // code->English nameï¼ˆAPI è¿”å›ï¼‰
let currencyToCca2 = {};           // code->cca2ï¼ˆRestCountries + Overrideï¼‰
let exchangeRates = {};            // USD base: 1 USD -> XXX
let baseCurrency = "USD";
let isUpdating = false;
let inputDebounceTimer = null;

/* ===========================
   DOM / Cache Utils
=========================== */
function $(id){ return document.getElementById(id); }

function updateStatus(type, text, withSpinner=false){
  const el = $("status");
  el.className = `status ${type}`;
  el.innerHTML = `${withSpinner ? '<span class="spinner"></span>' : ''}${text}`;
}

function nowZh(){
  return new Date().toLocaleString("zh-CN");
}

function loadCache(key, ttlMs){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || !obj.savedAt) return null;
    if(Date.now() - obj.savedAt > ttlMs) return null;
    return obj;
  }catch(_){ return null; }
}
function saveCache(key, payload){
  try{
    localStorage.setItem(key, JSON.stringify({ ...payload, savedAt: Date.now() }));
  }catch(_){}
}

function safeParseFloat(v){
  const n = parseFloat(String(v||"").replace(/,/g,""));
  return isNaN(n) ? 0 : n;
}
function formatNumber(num){
  if(isNaN(num)) return "";
  return num.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}
function formatRate(num){
  if(isNaN(num)) return "â€”";
  if(num >= 1000) return num.toFixed(2);
  if(num >= 10) return num.toFixed(4);
  return num.toFixed(6);
}

function getFlagUrl(cca2){
  if(!cca2) return "";
  return `https://flagcdn.com/w40/${cca2.toLowerCase()}.png`;
}
function getZhName(code){
  return ZH_NAME[code] || (codeNameEN[code] ? codeNameEN[code] : "â€”");
}

/* ===========================
   ä¸»é¢˜ UI
=========================== */
function updateThemeToggleUI(savedTheme, effective){
  const btn = $("themeToggle");
  let label = savedTheme === "system" ? "ğŸ–¥ï¸ è·Ÿéšç³»ç»Ÿ" : (savedTheme === "dark" ? "ğŸŒ™ æ·±è‰²" : "ğŸŒ æµ…è‰²");
  btn.innerText = label;
  btn.title = `å½“å‰: ${label}ï¼ˆæ˜¾ç¤º: ${effective === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²'}ï¼‰ã€‚å•å‡»åˆ‡æ¢ä¸»é¢˜ï¼ˆè·Ÿéšç³»ç»Ÿ â†’ æ·±è‰² â†’ æµ…è‰²ï¼‰`;
}
function loadThemeUI(){
  const saved = localStorage.getItem(THEME_KEY) || "system";
  const effective = saved === "system" ? getSystemTheme() : saved;
  updateThemeToggleUI(saved, effective);
}
function cycleTheme(){
  const cur = localStorage.getItem(THEME_KEY) || "system";
  const next = cur === "system" ? "dark" : (cur === "dark" ? "light" : "system");
  localStorage.setItem(THEME_KEY, next);
  applyTheme(next);
  const effective = next === "system" ? getSystemTheme() : next;
  updateThemeToggleUI(next, effective);
}

/* ===========================
   APIï¼šæ‹‰å–æ‰€æœ‰æ”¯æŒå¸ç§
=========================== */
async function fetchSupportedCodes({ force=false } = {}){
  if(!force){
    const cache = loadCache(CACHE.CODES, TTL.CODES_MS);
    if(cache?.codes?.length) return cache.codes;
  }
  const url = `${EXCHANGE_API_BASE}/${EXCHANGE_API_KEY}/codes`;
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("codes fetch failed");
  const data = await res.json();
  const arr = data?.supported_codes;
  if(!Array.isArray(arr)) throw new Error("codes response invalid");

  const codes = arr.map(x => ({ code: x[0], name: x[1] }));
  saveCache(CACHE.CODES, { codes });
  return codes;
}

/* ===========================
   APIï¼šå®æ—¶æ±‡ç‡ï¼ˆUSD åŸºå‡†ï¼‰
=========================== */
async function fetchLatestRatesUSD({ force=false } = {}){
  if(!force){
    const cache = loadCache(CACHE.RATES, TTL.RATES_MS);
    if(cache?.rates){
      return { rates: cache.rates, time: cache.displayTime || "ç¼“å­˜", source: cache.source || "cache" };
    }
  }
  const url = `${EXCHANGE_API_BASE}/${EXCHANGE_API_KEY}/latest/USD`;
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("latest fetch failed");
  const data = await res.json();
  const rates = data?.conversion_rates;
  if(!rates || typeof rates !== "object") throw new Error("latest response invalid");
  rates.USD = 1;

  const displayTime = data?.time_last_update_utc || nowZh();
  saveCache(CACHE.RATES, { rates, displayTime, source: "ExchangeRate-API" });

  return { rates, time: displayTime, source: "ExchangeRate-API" };
}

/* ===========================
   å›½æ——æ˜ å°„ï¼šRestCountries + å¼ºåˆ¶è¦†ç›– + å…œåº•
=========================== */
async function buildCurrencyCountryMap({ force=false } = {}){
  if(!force){
    const cache = loadCache(CACHE.COUNTRY_MAP, TTL.COUNTRY_MS);
    if(cache?.map && typeof cache.map === "object"){
      return cache.map;
    }
  }

  const url = "https://restcountries.com/v3.1/all?fields=currencies,cca2";
  const res = await fetch(url, { cache: "no-store" });
  if(!res.ok) throw new Error("restcountries fetch failed");
  const data = await res.json();
  if(!Array.isArray(data)) throw new Error("restcountries response invalid");

  const map = {};
  for(const c of data){
    const cca2 = c?.cca2;
    const currencies = c?.currencies;
    if(!cca2 || !currencies || typeof currencies !== "object") continue;
    for(const code of Object.keys(currencies)){
      if(!map[code]) map[code] = cca2;
    }
  }

  for(const code in FLAG_OVERRIDE){
    map[code] = FLAG_OVERRIDE[code];
  }

  saveCache(CACHE.COUNTRY_MAP, { map });
  return map;
}

/* ===========================
   æ’åºï¼šå¸¸ç”¨å¸ç§ç½®é¡¶ï¼Œå…¶ä½™æŒ‰å­—æ¯
=========================== */
function sortSupportedCodes(list){
  const preferredRank = {};
  PREFERRED_ORDER.forEach((c, i)=>preferredRank[c] = i);

  return [...list].sort((a,b)=>{
    const ra = preferredRank[a.code];
    const rb = preferredRank[b.code];
    const aPref = ra !== undefined;
    const bPref = rb !== undefined;
    if(aPref && bPref) return ra - rb;
    if(aPref) return -1;
    if(bPref) return 1;
    return a.code.localeCompare(b.code);
  });
}

/* ===========================
   æ¸²æŸ“ï¼ˆå±•ç¤ºæ‰€æœ‰å¸ç§ï¼Œåˆ†æ‰¹æ¸²æŸ“é¿å…å¡é¡¿ï¼‰
=========================== */
function createFlagNode(code){
  const cca2 = currencyToCca2[code] || "";
  const url = getFlagUrl(cca2);
  if(!url){
    const fb = document.createElement("div");
    fb.className = "flag-fallback";
    fb.textContent = code.slice(0,2);
    return fb;
  }

  const img = document.createElement("img");
  img.className = "flag";
  img.alt = code;
  img.src = url;

  img.onerror = () => {
    const fb = document.createElement("div");
    fb.className = "flag-fallback";
    fb.textContent = code.slice(0,2);
    img.replaceWith(fb);
  };
  return img;
}

function createCard(code){
  const zh = getZhName(code);
  const en = codeNameEN[code] || "";

  const card = document.createElement("div");
  card.className = "card";
  card.dataset.code = code;

  const flagNode = createFlagNode(code);

  const top = document.createElement("div");
  top.className = "card-top";
  top.innerHTML = `
    <div class="cur-left">
      <div class="cur-meta">
        <div class="cur-code">${code}</div>
        <div class="cur-zh" title="${zh}">${zh}</div>
        <div class="cur-en" title="${en}">${en}</div>
      </div>
    </div>
    <div class="badge" id="badge-${code}">${code === baseCurrency ? "åŸºå‡†" : "ç›®æ ‡"}</div>
  `;

  top.querySelector(".cur-left").prepend(flagNode);

  const rate = document.createElement("div");
  rate.className = "rate";
  rate.id = `rate-${code}`;
  rate.textContent = "æ±‡ç‡ï¼šåŠ è½½ä¸­â€¦";

  const input = document.createElement("input");
  input.className = "input";
  input.id = `input-${code}`;
  input.type = "text";
  input.inputMode = "decimal";
  input.placeholder = "0.00";
  input.addEventListener("focus", ()=>onInputFocus(code));
  input.addEventListener("input", ()=>onInputChangeDebounced(code));

  card.appendChild(top);
  card.appendChild(rate);
  card.appendChild(input);
  return card;
}

function renderAllChunked(){
  const grid = $("grid");
  grid.innerHTML = "";

  const codes = supported.map(x=>x.code);
  const batchSize = 28;
  let i = 0;

  function renderBatch(){
    const frag = document.createDocumentFragment();
    for(let k = 0; k < batchSize && i < codes.length; k++, i++){
      frag.appendChild(createCard(codes[i]));
    }
    grid.appendChild(frag);

    updateRateDisplays();

    if(i < codes.length){
      if("requestIdleCallback" in window){
        requestIdleCallback(renderBatch, { timeout: 250 });
      }else{
        setTimeout(renderBatch, 0);
      }
    }
  }
  renderBatch();
}

function updateRateDisplays(){
  $("baseLabel").textContent = baseCurrency;

  for(const {code} of supported){
    const rateEl = document.getElementById(`rate-${code}`);
    const badgeEl = document.getElementById(`badge-${code}`);
    if(!rateEl) continue;

    if(badgeEl){
      badgeEl.textContent = (code === baseCurrency) ? "åŸºå‡†" : "ç›®æ ‡";
    }

    if(code === baseCurrency){
      rateEl.textContent = `æ±‡ç‡ï¼š1.0000ï¼ˆåŸºå‡†ï¼‰`;
      continue;
    }
    const b = exchangeRates[baseCurrency];
    const t = exchangeRates[code];
    if(!b || !t){
      rateEl.textContent = "æ±‡ç‡ï¼šæ•°æ®ä¸å¯ç”¨";
      continue;
    }
    const r = t / b;
    rateEl.textContent = `æ±‡ç‡ï¼š${formatRate(r)}`;
  }
}

/* ===========================
   è¾“å…¥è”åŠ¨ï¼ˆé˜²æŠ– + æ‰¹é‡æ›´æ–°ï¼‰
=========================== */
function onInputFocus(code){
  baseCurrency = code;
  updateRateDisplays();

  const input = document.getElementById(`input-${code}`);
  if(input) input.value = input.value.replace(/,/g,"");
}

function onInputChangeDebounced(code){
  clearTimeout(inputDebounceTimer);
  inputDebounceTimer = setTimeout(()=>onInputChange(code), 90);
}

function onInputChange(code){
  if(isUpdating) return;
  if(!exchangeRates[code]) return;

  const inputEl = document.getElementById(`input-${code}`);
  const val = safeParseFloat(inputEl?.value);

  baseCurrency = code;
  updateRateDisplays();

  isUpdating = true;
  for(const {code: k} of supported){
    if(k === code) continue;
    const el = document.getElementById(`input-${k}`);
    if(!el) continue;

    const a = exchangeRates[k];
    const b = exchangeRates[code];
    if(!a || !b){
      el.value = "";
      continue;
    }
    const converted = val * a / b;
    el.value = formatNumber(converted);
  }
  isUpdating = false;
}

/* ===========================
   åˆ·æ–°é€»è¾‘
=========================== */
async function refreshRates(force=true){
  const btn = $("refreshBtn");
  btn.disabled = true;
  btn.innerHTML = `<span class="spinner"></span> åˆ·æ–°ä¸­`;

  try{
    updateStatus("loading", "æ­£åœ¨åˆ·æ–°æ±‡ç‡â€¦", true);

    const latest = await fetchLatestRatesUSD({ force });
    exchangeRates = latest.rates;

    updateRateDisplays();
    $("lastUpdated").textContent = `æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´ï¼š${latest.time}ï¼ˆå®æ—¶ï¼‰`;

    updateStatus("success", `å°±ç»ªï¼ˆæ¥æºï¼š${latest.source} Â· å¸ç§ï¼š${supported.length}ï¼‰`);
  }catch(e){
    console.error(e);
    updateStatus("error", "åˆ·æ–°å¤±è´¥ï¼šè¯·æ£€æŸ¥ API Key / ç½‘ç»œ / CORSï¼ˆå·²ä¿ç•™ä¸Šæ¬¡ç¼“å­˜æ•°æ®ï¼‰");
  }finally{
    btn.disabled = false;
    btn.innerHTML = `ğŸ”„ åˆ·æ–°æ±‡ç‡`;
  }
}

/* ===========================
   åˆå§‹åŒ–
=========================== */
async function init(){
  loadThemeUI();
  $("themeToggle").addEventListener("click", cycleTheme);

  const mediaQuery = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)");
  if(mediaQuery){
    try{
      mediaQuery.addEventListener("change", ()=>{
        const saved = localStorage.getItem(THEME_KEY) || "system";
        if(saved === "system"){
          applyTheme("system");
          loadThemeUI();
        }
      });
    }catch(_){}
  }

  $("refreshBtn").addEventListener("click", ()=>refreshRates(true));

  updateStatus("loading", "åŠ è½½æ‰€æœ‰æ”¯æŒå¸ç§â€¦", true);

  supported = await fetchSupportedCodes({ force:false });
  supported = sortSupportedCodes(supported);

  codeNameEN = {};
  for(const x of supported){
    codeNameEN[x.code] = x.name;
  }

  $("countLabel").textContent = String(supported.length);

  updateStatus("loading", "æ„å»ºå›½æ——æ˜ å°„ï¼ˆå¢å¼ºï¼‰â€¦", true);

  try{
    currencyToCca2 = await buildCurrencyCountryMap({ force:false });
  }catch(e){
    console.warn("flag map build failed:", e);
    currencyToCca2 = { ...FLAG_OVERRIDE };
  }

  updateStatus("loading", "æ¸²æŸ“å…¨éƒ¨å¸ç§â€¦", true);
  renderAllChunked();

  try{
    updateStatus("loading", "è·å–å®æ—¶æ±‡ç‡â€¦", true);
    const latest = await fetchLatestRatesUSD({ force:false });
    exchangeRates = latest.rates;

    updateRateDisplays();
    $("lastUpdated").textContent = `æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´ï¼š${latest.time}ï¼ˆå®æ—¶ï¼‰`;
    updateStatus("success", `å°±ç»ªï¼ˆå¸ç§ï¼š${supported.length} Â· å¸¸ç”¨å¸ç§å·²ç½®é¡¶ï¼‰`);
  }catch(e){
    console.error(e);
    updateStatus("error", "è·å–æ±‡ç‡å¤±è´¥ï¼šè¯·æ£€æŸ¥ API Key / ç½‘ç»œ / CORS");
    $("lastUpdated").textContent = `æ±‡ç‡æ•°æ®æ›´æ–°æ—¶é—´ï¼šå¤±è´¥ï¼ˆæ— æ•°æ®ï¼‰`;
  }
}

window.addEventListener("load", init);
</script>
</body>
</html>
